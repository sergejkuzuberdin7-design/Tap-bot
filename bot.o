import asyncio
import logging
import sqlite3
from datetime import datetime, timedelta
from aiogram import Bot, Dispatcher, types
from aiogram.filters import Command, StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder
import json

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
BOT_TOKEN = "8261105884:AAErE78hJRbZkvdXTYyv3qdHTGM7dwxT7vY"
ADMIN_ID = 7871475865
SUPPORT_USERNAME = "@izmony"

# –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
REQUIRED_CHANNEL = {
    "id": "-1002895358183",
    "username": "@ProfitMaker557",
    "name": "–ù–∞—à –∫–∞–Ω–∞–ª"
}

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞
MIN_DEPOSIT = 1.0
MIN_WITHDRAWAL = 10.0
MIN_COLLECT = 1.0
REFERRAL_PERCENT_INVEST = 15
REFERRAL_PERCENT_WITHDRAW = 0.5
PROFIT_PERCENT = 8.0
BOT_USERNAME = "@ProfitMakerPro_bot"

# –ù–∞–≥—Ä–∞–¥—ã –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
REWARD_PRICES = {
    "post": 50.0,
    "video": 100.0,
    "story": 25.0,
    "review": 30.0
}

# –†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã
PAYMENT_DETAILS = {
    "sbp": {
        "bank": "–°–±–µ—Ä–±–∞–Ω–∫",
        "phone": "+79592741128",
        "recipient": "–°–µ—Ä–≥–µ–π –ö."
    },
    "card": {
        "bank": "–°–±–µ—Ä–±–∞–Ω–∫",
        "card_number": "2202208205962757",
        "recipient": "–°–µ—Ä–≥–µ–π –ö."
    },
    "payeer": {
        "account": "P1128063300",
        "wallet": "RUB",
        "link": "payeer.com"
    }
}

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–∞–π–º–µ—Ä–æ–≤
active_timers = {}

# –°–æ—Å—Ç–æ—è–Ω–∏—è FSM
class UserStates(StatesGroup):
    waiting_deposit_amount = State()
    waiting_withdraw_amount = State()
    waiting_withdraw_method = State()
    waiting_calc_amount = State()
    waiting_deposit_method = State()
    waiting_invest_amount = State()
    waiting_support_message = State()
    waiting_reward_proof = State()

class AdminStates(StatesGroup):
    waiting_broadcast = State()
    waiting_deposit_user_id = State()
    waiting_deposit_amount = State()
    waiting_freeze_user_id = State()
    waiting_freeze_reason = State()
    waiting_block_user_id = State()
    waiting_block_reason = State()
    waiting_bot_token = State()
    waiting_admin_id = State()
    waiting_min_deposit = State()
    waiting_min_withdrawal = State()
    waiting_min_collect = State()
    waiting_profit_percent = State()
    waiting_referral_invest = State()
    waiting_referral_withdraw = State()
    waiting_bot_username = State()
    waiting_support_username = State()
    waiting_channel_id = State()
    waiting_channel_username = State()
    waiting_channel_name = State()
    waiting_payment_details = State()
    waiting_payment_type = State()
    waiting_reward_price = State()
    waiting_reward_type = State()

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
class Database:
    def __init__(self):
        self.conn = sqlite3.connect('invest_bot.db', check_same_thread=False)
        self.create_tables()

    def create_tables(self):
        cursor = self.conn.cursor()

        cursor.execute('''
            CREATE TABLE IF NOT EXISTS users (
                user_id INTEGER PRIMARY KEY,
                username TEXT,
                first_name TEXT,
                balance REAL DEFAULT 0,
                ref_balance REAL DEFAULT 0,
                total_invested REAL DEFAULT 0,
                total_earned REAL DEFAULT 0,
                referral_id INTEGER,
                referrals_count INTEGER DEFAULT 0,
                notifications_enabled INTEGER DEFAULT 1,
                has_subscribed INTEGER DEFAULT 0,
                is_blocked INTEGER DEFAULT 0,
                is_frozen INTEGER DEFAULT 0,
                freeze_reason TEXT,
                block_reason TEXT,
                registered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        cursor.execute('''
            CREATE TABLE IF NOT EXISTS investments (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                amount REAL,
                accumulated REAL DEFAULT 0,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                is_active INTEGER DEFAULT 1,
                FOREIGN KEY (user_id) REFERENCES users (user_id)
            )
        ''')

        cursor.execute('''
            CREATE TABLE IF NOT EXISTS operations (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                operation TEXT,
                amount REAL,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users (user_id)
            )
        ''')

        cursor.execute('''
            CREATE TABLE IF NOT EXISTS withdrawal_requests (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                amount REAL,
                method TEXT,
                details TEXT,
                status TEXT DEFAULT 'pending',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        cursor.execute('''
            CREATE TABLE IF NOT EXISTS deposit_requests (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                amount REAL,
                method TEXT,
                status TEXT DEFAULT 'pending',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        cursor.execute('''
            CREATE TABLE IF NOT EXISTS support_requests (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                message TEXT,
                status TEXT DEFAULT 'pending',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        cursor.execute('''
            CREATE TABLE IF NOT EXISTS reward_requests (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                reward_type TEXT,
                proof_text TEXT,
                amount REAL,
                status TEXT DEFAULT 'pending',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        cursor.execute('''
            CREATE TABLE IF NOT EXISTS bot_settings (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                setting_name TEXT UNIQUE,
                setting_value TEXT,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')

        self.conn.commit()
        print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")

    def save_setting(self, name, value):
        cursor = self.conn.cursor()
        cursor.execute(
            'INSERT OR REPLACE INTO bot_settings (setting_name, setting_value) VALUES (?, ?)',
            (name, str(value))
        )
        self.conn.commit()

    def get_setting(self, name, default=None):
        cursor = self.conn.cursor()
        cursor.execute(
            'SELECT setting_value FROM bot_settings WHERE setting_name = ?', (name,))
        result = cursor.fetchone()
        if result:
            return result[0]
        return default

    def get_all_settings(self):
        cursor = self.conn.cursor()
        cursor.execute('SELECT setting_name, setting_value FROM bot_settings')
        return {row[0]: row[1] for row in cursor.fetchall()}

    def add_user(self, user_id, username, first_name, referral_id=None):
        cursor = self.conn.cursor()
        try:
            cursor.execute(
                'INSERT OR IGNORE INTO users (user_id, username, first_name, referral_id) VALUES (?, ?, ?, ?)',
                (user_id, username, first_name, referral_id)
            )
            if referral_id:
                cursor.execute(
                    'UPDATE users SET referrals_count = referrals_count + 1 WHERE user_id = ?',
                    (referral_id,)
                )
            self.conn.commit()
        except Exception as e:
            print(f"Error adding user: {e}")

    def get_user(self, user_id):
        cursor = self.conn.cursor()
        cursor.execute('SELECT * FROM users WHERE user_id = ?', (user_id,))
        return cursor.fetchone()

    def update_balance(self, user_id, amount):
        cursor = self.conn.cursor()
        cursor.execute(
            'UPDATE users SET balance = balance + ? WHERE user_id = ?', (amount, user_id))
        self.conn.commit()

    def freeze_user(self, user_id, reason):
        cursor = self.conn.cursor()
        cursor.execute(
            'UPDATE users SET is_frozen = 1, freeze_reason = ? WHERE user_id = ?',
            (reason, user_id)
        )
        self.conn.commit()

    def unfreeze_user(self, user_id):
        cursor = self.conn.cursor()
        cursor.execute(
            'UPDATE users SET is_frozen = 0, freeze_reason = NULL WHERE user_id = ?',
            (user_id,)
        )
        self.conn.commit()

    def block_user(self, user_id, reason):
        cursor = self.conn.cursor()
        cursor.execute(
            'UPDATE users SET is_blocked = 1, block_reason = ? WHERE user_id = ?',
            (reason, user_id)
        )
        self.conn.commit()

    def unblock_user(self, user_id):
        cursor = self.conn.cursor()
        cursor.execute(
            'UPDATE users SET is_blocked = 0, block_reason = NULL WHERE user_id = ?',
            (user_id,)
        )
        self.conn.commit()

    def add_investment(self, user_id, amount):
        cursor = self.conn.cursor()
        current_investment = self.get_active_investment(user_id)

        if current_investment:
            new_amount = current_investment[2] + amount
            cursor.execute(
                'UPDATE investments SET amount = ? WHERE id = ?',
                (new_amount, current_investment[0])
            )
        else:
            cursor.execute(
                'INSERT INTO investments (user_id, amount) VALUES (?, ?)',
                (user_id, amount)
            )

        cursor.execute(
            'UPDATE users SET total_invested = total_invested + ? WHERE user_id = ?',
            (amount, user_id)
        )
        self.conn.commit()

    def get_active_investment(self, user_id):
        cursor = self.conn.cursor()
        cursor.execute(
            'SELECT * FROM investments WHERE user_id = ? AND is_active = 1 ORDER BY created_at DESC LIMIT 1',
            (user_id,)
        )
        return cursor.fetchone()

    def update_investment_accumulated(self, investment_id, accumulated):
        cursor = self.conn.cursor()
        cursor.execute(
            'UPDATE investments SET accumulated = ?, last_updated = ? WHERE id = ?',
            (accumulated, datetime.now(), investment_id)
        )
        self.conn.commit()

    def reset_investment_accumulated(self, investment_id):
        cursor = self.conn.cursor()
        cursor.execute(
            'UPDATE investments SET accumulated = 0, last_updated = ? WHERE id = ?',
            (datetime.now(), investment_id)
        )
        self.conn.commit()

    def add_operation(self, user_id, operation, amount):
        cursor = self.conn.cursor()
        cursor.execute(
            'INSERT INTO operations (user_id, operation, amount) VALUES (?, ?, ?)',
            (user_id, operation, amount)
        )
        self.conn.commit()

    def get_recent_operations(self, limit=5):
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT u.user_id, o.operation, o.amount, o.created_at
            FROM operations o
            JOIN users u ON o.user_id = u.user_id
            ORDER BY o.created_at DESC
            LIMIT ?
        ''', (limit,))
        return cursor.fetchall()

    def add_withdrawal_request(self, user_id, amount, method, details):
        cursor = self.conn.cursor()
        cursor.execute(
            'INSERT INTO withdrawal_requests (user_id, amount, method, details) VALUES (?, ?, ?, ?)',
            (user_id, amount, method, details)
        )
        self.conn.commit()
        return cursor.lastrowid

    def get_pending_withdrawals(self):
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT wr.*, u.username, u.first_name
            FROM withdrawal_requests wr
            JOIN users u ON wr.user_id = u.user_id
            WHERE wr.status = 'pending'
        ''')
        return cursor.fetchall()

    def get_withdrawal_by_id(self, withdrawal_id):
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT wr.*, u.username, u.first_name
            FROM withdrawal_requests wr
            JOIN users u ON wr.user_id = u.user_id
            WHERE wr.id = ?
        ''', (withdrawal_id,))
        return cursor.fetchone()

    def update_withdrawal_status(self, withdrawal_id, status):
        cursor = self.conn.cursor()
        cursor.execute(
            'UPDATE withdrawal_requests SET status = ? WHERE id = ?',
            (status, withdrawal_id)
        )
        self.conn.commit()

    def add_deposit_request(self, user_id, amount, method):
        cursor = self.conn.cursor()
        cursor.execute(
            'INSERT INTO deposit_requests (user_id, amount, method) VALUES (?, ?, ?)',
            (user_id, amount, method)
        )
        self.conn.commit()
        return cursor.lastrowid

    def get_pending_deposits(self):
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT dr.*, u.username, u.first_name
            FROM deposit_requests dr
            JOIN users u ON dr.user_id = u.user_id
            WHERE dr.status = 'pending'
        ''')
        return cursor.fetchall()

    def get_deposit_by_id(self, deposit_id):
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT dr.*, u.username, u.first_name
            FROM deposit_requests dr
            JOIN users u ON dr.user_id = u.user_id
            WHERE dr.id = ?
        ''', (deposit_id,))
        return cursor.fetchone()

    def update_deposit_status(self, deposit_id, status):
        cursor = self.conn.cursor()
        cursor.execute(
            'UPDATE deposit_requests SET status = ? WHERE id = ?',
            (status, deposit_id)
        )
        self.conn.commit()

    def add_support_request(self, user_id, message):
        cursor = self.conn.cursor()
        cursor.execute(
            'INSERT INTO support_requests (user_id, message) VALUES (?, ?)',
            (user_id, message)
        )
        self.conn.commit()
        return cursor.lastrowid

    def get_pending_support_requests(self):
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT sr.*, u.username, u.first_name
            FROM support_requests sr
            JOIN users u ON sr.user_id = u.user_id
            WHERE sr.status = 'pending'
        ''')
        return cursor.fetchall()

    def get_support_request_by_id(self, request_id):
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT sr.*, u.username, u.first_name
            FROM support_requests sr
            JOIN users u ON sr.user_id = u.user_id
            WHERE sr.id = ?
        ''', (request_id,))
        return cursor.fetchone()

    def update_support_request_status(self, request_id, status):
        cursor = self.conn.cursor()
        cursor.execute(
            'UPDATE support_requests SET status = ? WHERE id = ?',
            (status, request_id)
        )
        self.conn.commit()

    def add_reward_request(self, user_id, reward_type, proof_text, amount):
        cursor = self.conn.cursor()
        cursor.execute(
            'INSERT INTO reward_requests (user_id, reward_type, proof_text, amount) VALUES (?, ?, ?, ?)',
            (user_id, reward_type, proof_text, amount)
        )
        self.conn.commit()
        return cursor.lastrowid

    def get_pending_reward_requests(self):
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT rr.*, u.username, u.first_name
            FROM reward_requests rr
            JOIN users u ON rr.user_id = u.user_id
            WHERE rr.status = 'pending'
        ''')
        return cursor.fetchall()

    def get_reward_request_by_id(self, request_id):
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT rr.*, u.username, u.first_name
            FROM reward_requests rr
            JOIN users u ON rr.user_id = u.user_id
            WHERE rr.id = ?
        ''', (request_id,))
        return cursor.fetchone()

    def update_reward_request_status(self, request_id, status):
        cursor = self.conn.cursor()
        cursor.execute(
            'UPDATE reward_requests SET status = ? WHERE id = ?',
            (status, request_id)
        )
        self.conn.commit()

    def get_all_users(self):
        cursor = self.conn.cursor()
        cursor.execute('SELECT user_id FROM users')
        return [row[0] for row in cursor.fetchall()]

    def get_users_count(self):
        cursor = self.conn.cursor()
        cursor.execute('SELECT COUNT(*) FROM users')
        return cursor.fetchone()[0]

    def get_active_investors_count(self):
        cursor = self.conn.cursor()
        cursor.execute(
            'SELECT COUNT(DISTINCT user_id) FROM investments WHERE is_active = 1')
        return cursor.fetchone()[0]

    def get_new_users_last_24h(self):
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT COUNT(*) FROM users
            WHERE datetime(registered_at) > datetime('now', '-1 day')
        ''')
        return cursor.fetchone()[0]

    def get_total_invested(self):
        cursor = self.conn.cursor()
        cursor.execute('SELECT SUM(total_invested) FROM users')
        result = cursor.fetchone()[0]
        return result if result else 0.0

    def get_total_earned(self):
        cursor = self.conn.cursor()
        cursor.execute('SELECT SUM(total_earned) FROM users')
        result = cursor.fetchone()[0]
        return result if result else 0.0

    def get_online_users_count(self):
        cursor = self.conn.cursor()
        cursor.execute('''
            SELECT COUNT(DISTINCT user_id) FROM operations
            WHERE datetime(created_at) > datetime('now', '-10 minutes')
        ''')
        return cursor.fetchone()[0]

    def update_notifications(self, user_id, enabled):
        cursor = self.conn.cursor()
        cursor.execute(
            'UPDATE users SET notifications_enabled = ? WHERE user_id = ?',
            (1 if enabled else 0, user_id)
        )
        self.conn.commit()

    def update_subscription_status(self, user_id, has_subscribed):
        cursor = self.conn.cursor()
        cursor.execute(
            'UPDATE users SET has_subscribed = ? WHERE user_id = ?',
            (1 if has_subscribed else 0, user_id)
        )
        self.conn.commit()

db = Database()

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
def load_settings():
    global BOT_TOKEN, ADMIN_ID, SUPPORT_USERNAME, REQUIRED_CHANNEL, MIN_DEPOSIT, MIN_WITHDRAWAL, MIN_COLLECT
    global REFERRAL_PERCENT_INVEST, REFERRAL_PERCENT_WITHDRAW, PROFIT_PERCENT, BOT_USERNAME, PAYMENT_DETAILS, REWARD_PRICES

    settings = db.get_all_settings()

    if settings:
        BOT_TOKEN = settings.get('bot_token', BOT_TOKEN)
        ADMIN_ID = int(settings.get('admin_id', ADMIN_ID))
        SUPPORT_USERNAME = settings.get('support_username', SUPPORT_USERNAME)

        REQUIRED_CHANNEL["id"] = settings.get('channel_id', REQUIRED_CHANNEL["id"])
        REQUIRED_CHANNEL["username"] = settings.get('channel_username', REQUIRED_CHANNEL["username"])
        REQUIRED_CHANNEL["name"] = settings.get('channel_name', REQUIRED_CHANNEL["name"])

        MIN_DEPOSIT = float(settings.get('min_deposit', MIN_DEPOSIT))
        MIN_WITHDRAWAL = float(settings.get('min_withdrawal', MIN_WITHDRAWAL))
        MIN_COLLECT = float(settings.get('min_collect', MIN_COLLECT))
        REFERRAL_PERCENT_INVEST = float(settings.get('referral_invest', REFERRAL_PERCENT_INVEST))
        REFERRAL_PERCENT_WITHDRAW = float(settings.get('referral_withdraw', REFERRAL_PERCENT_WITHDRAW))
        PROFIT_PERCENT = float(settings.get('profit_percent', PROFIT_PERCENT))
        BOT_USERNAME = settings.get('bot_username', BOT_USERNAME)

        payment_json = settings.get('payment_details')
        if payment_json:
            PAYMENT_DETAILS = json.loads(payment_json)

        rewards_json = settings.get('reward_prices')
        if rewards_json:
            REWARD_PRICES = json.loads(rewards_json)

load_settings()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
async def check_subscription(user_id):
    try:
        member = await bot.get_chat_member(chat_id=REQUIRED_CHANNEL["id"], user_id=user_id)
        return member.status in ['member', 'administrator', 'creator']
    except Exception as e:
        print(f"Error checking subscription: {e}")
        return False

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥–ø–∏—Å–∫–∏
def get_subscription_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text=f"üì¢ {REQUIRED_CHANNEL['name']}", url=f"https://t.me/{REQUIRED_CHANNEL['username'][1:]}")
    builder.button(text="‚úÖ –Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è", callback_data="check_subscription")
    builder.adjust(1)
    return builder.as_markup()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π –ø—Ä–∏–±—ã–ª–∏
def calculate_accumulated_profit(investment):
    if not investment:
        return 0.0

    try:
        invested_amount = investment[2]
        last_updated = investment[5]
        already_accumulated = investment[3]

        if isinstance(last_updated, str):
            last_updated = datetime.fromisoformat(last_updated.replace('Z', '+00:00'))

        now = datetime.now()
        time_passed = now - last_updated
        hours_passed = time_passed.total_seconds() / 3600

        hourly_profit_percent = PROFIT_PERCENT / 24 / 100
        new_profit = invested_amount * hourly_profit_percent * hours_passed

        total_accumulated = already_accumulated + new_profit
        max_daily_profit = invested_amount * (PROFIT_PERCENT / 100)

        return min(total_accumulated, max_daily_profit)

    except Exception as e:
        print(f"Error calculating profit: {e}")
        return 0.0

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è
def get_accumulation_progress(investment):
    if not investment:
        return "0%"

    try:
        invested_amount = investment[2]
        accumulated = calculate_accumulated_profit(investment)
        max_daily_profit = invested_amount * (PROFIT_PERCENT / 100)

        if max_daily_profit == 0:
            return "0%"

        progress = (accumulated / max_daily_profit) * 100
        return f"{progress:.1f}%"

    except Exception as e:
        print(f"Error calculating progress: {e}")
        return "0%"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
async def update_investment_progress(user_id, message_id):
    try:
        while user_id in active_timers and active_timers[user_id]:
            investment = db.get_active_investment(user_id)

            if not investment:
                break

            invested_amount = investment[2] if investment else 0.0
            accumulated_profit = calculate_accumulated_profit(investment)
            progress = get_accumulation_progress(investment)

            db.update_investment_accumulated(investment[0], accumulated_profit)

            text = f"""
<b>‚ñ™Ô∏è –û—Ç–∫—Ä—ã–≤–∞–π –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ –ø–æ–ª—É—á–∞–π —Å—Ç–∞–±–∏–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å –≤ –¥–∞–Ω–Ω–æ–º —Ä–∞–∑–¥–µ–ª–µ, –ø–æ—Å–ª–µ —Å–æ–±–∏—Ä–∞–π –¥–æ—Ö–æ–¥:</b>

üí∞ <b>–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–±—ã–ª–∏:</b> {PROFIT_PERCENT}% –≤ —Å—É—Ç–∫–∏
‚è± <b>–í—Ä–µ–º—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è:</b> 24 —á–∞—Å–∞
üìÜ <b>–°—Ä–æ–∫ –≤–∫–ª–∞–¥–∞:</b> –ü–æ–∂–∏–∑–Ω–µ–Ω–Ω–æ

üí≥ <b>–í–∞—à –≤–∫–ª–∞–¥:</b> {invested_amount:.1f}‚ÇΩ
üíµ <b>–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ:</b> {accumulated_profit:.2f}‚ÇΩ

üìä <b>–ü—Ä–æ–≥—Ä–µ—Å—Å:</b> {progress}
üí° <b>–ú–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –æ—Ç {MIN_COLLECT}‚ÇΩ</b>
    """

            try:
                await bot.edit_message_text(
                    chat_id=user_id,
                    message_id=message_id,
                    text=text,
                    reply_markup=get_investment_keyboard(),
                    parse_mode="HTML"
                )
            except Exception:
                break

            await asyncio.sleep(1)

    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –≤ —Ç–∞–π–º–µ—Ä–µ: {e}")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–Ω–µ–π —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
def get_days_working():
    cursor = db.conn.cursor()
    cursor.execute('SELECT MIN(registered_at) FROM users')
    result = cursor.fetchone()[0]
    if result:
        if isinstance(result, str):
            start_date = datetime.fromisoformat(result.replace('Z', '+00:00'))
        else:
            start_date = result
        now = datetime.now()
        days_working = (now - start_date).days
        return max(days_working, 1)
    return 1

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
def get_main_keyboard():
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üñ• –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏"), KeyboardButton(text="üëî –ü–∞—Ä—Ç–Ω—ë—Ä–∞–º")],
            [KeyboardButton(text="üí≥ –ö–æ—à–µ–ª—ë–∫"), KeyboardButton(text="üì† –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä")],
            [KeyboardButton(text="üÜò –ü–æ–º–æ—â—å –≤ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–∏"), KeyboardButton(text="üìî –û–±—É—á–µ–Ω–∏–µ")],
            [KeyboardButton(text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")]
        ],
        resize_keyboard=True
    )
    return keyboard

def get_investment_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="üí≥ –ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data="invest")
    builder.button(text="üí∞ –°–æ–±—Ä–∞—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è", callback_data="collect")
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")
    builder.adjust(1)
    return builder.as_markup()

def get_partners_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è", url="https://t.me/your_channel")
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")
    builder.adjust(1)
    return builder.as_markup()

def get_wallet_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="üì• –ü–æ–ø–æ–ª–Ω–∏—Ç—å", callback_data="deposit")
    builder.button(text="üì§ –í—ã–≤–µ—Å—Ç–∏", callback_data="withdraw")
    builder.button(text="üîÑ –†–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data="reinvest")
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")
    builder.adjust(1)
    return builder.as_markup()

def get_deposit_methods_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="üí≥ –°–ë–ü", callback_data="deposit_sbp")
    builder.button(text="üí≥ –ö–∞—Ä—Ç–∞", callback_data="deposit_card")
    builder.button(text="üÖøÔ∏è Payeer", callback_data="deposit_payeer")
    builder.button(text="üë®‚Äçüíº –†—É—á–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ", callback_data="deposit_manual")
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_wallet")
    builder.adjust(1)
    return builder.as_markup()

def get_withdraw_methods_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="üí≥ –ù–∞ –∫–∞—Ä—Ç—É", callback_data="withdraw_card")
    builder.button(text="üÖøÔ∏è Payeer", callback_data="withdraw_payeer")
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_wallet")
    builder.adjust(1)
    return builder.as_markup()

def get_settings_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="statistics")
    builder.button(text="üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä", url=f"https://t.me/{SUPPORT_USERNAME[1:]}")
    builder.button(text="üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", callback_data="notifications")
    builder.button(text="üìã –û–ø–µ—Ä–∞—Ü–∏–∏", callback_data="operations")
    builder.button(text="üÜò –°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π", callback_data="support")
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")
    builder.adjust(1)
    return builder.as_markup()

def get_promotion_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="üìù –ü–æ—Å—Ç –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö", callback_data="reward_post")
    builder.button(text="üé• –í–∏–¥–µ–æ-–æ–±–∑–æ—Ä", callback_data="reward_video")
    builder.button(text="‚ú® –°—Ç–æ—Ä–∏—Å", callback_data="reward_story")
    builder.button(text="‚≠ê –û—Ç–∑—ã–≤", callback_data="reward_review")
    builder.button(text="üÜò –°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π", callback_data="support")
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")
    builder.adjust(1)
    return builder.as_markup()

def get_admin_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="üì¢ –†–∞—Å—Å—ã–ª–∫–∞", callback_data="admin_broadcast")
    builder.button(text="üí≥ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å", callback_data="admin_deposit")
    builder.button(text="üìã –ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥", callback_data="admin_withdrawals")
    builder.button(text="üì• –ó–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ", callback_data="admin_deposit_requests")
    builder.button(text="üÜò –ó–∞—è–≤–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏", callback_data="admin_support_requests")
    builder.button(text="üéÅ –ó–∞—è–≤–∫–∏ –Ω–∞ –Ω–∞–≥—Ä–∞–¥—ã", callback_data="admin_reward_requests")
    builder.button(text="üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏", callback_data="admin_user_management")
    builder.button(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats")
    builder.button(text="‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º", callback_data="admin_management")
    builder.button(text="‚óÄÔ∏è –í—ã—Ö–æ–¥", callback_data="back_to_main")
    builder.adjust(1)
    return builder.as_markup()

def get_user_management_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="‚ùÑÔ∏è –ó–∞–º–æ—Ä–æ–∑–∏—Ç—å –±–∞–ª–∞–Ω—Å", callback_data="admin_freeze_user")
    builder.button(text="üî• –†–∞–∑–º–æ—Ä–æ–∑–∏—Ç—å –±–∞–ª–∞–Ω—Å", callback_data="admin_unfreeze_user")
    builder.button(text="üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", callback_data="admin_block_user")
    builder.button(text="‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", callback_data="admin_unblock_user")
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_panel")
    builder.adjust(1)
    return builder.as_markup()

def get_management_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="ü§ñ –¢–æ–∫–µ–Ω –±–æ—Ç–∞", callback_data="manage_bot_token")
    builder.button(text="üëë ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞", callback_data="manage_admin_id")
    builder.button(text="üíµ –ú–∏–Ω. –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ", callback_data="manage_min_deposit")
    builder.button(text="üí∏ –ú–∏–Ω. –≤—ã–≤–æ–¥", callback_data="manage_min_withdrawal")
    builder.button(text="üí∞ –ú–∏–Ω. —Å–±–æ—Ä", callback_data="manage_min_collect")
    builder.button(text="üìà % –ø—Ä–∏–±—ã–ª–∏", callback_data="manage_profit_percent")
    builder.button(text="üë• % —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–∏–Ω–≤–µ—Å—Ç)", callback_data="manage_referral_invest")
    builder.button(text="üë• % —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (–≤—ã–≤–æ–¥)", callback_data="manage_referral_withdraw")
    builder.button(text="üîó –ò–º—è –±–æ—Ç–∞", callback_data="manage_bot_username")
    builder.button(text="üë®‚Äçüíº –ü–æ–¥–¥–µ—Ä–∂–∫–∞", callback_data="manage_support_username")
    builder.button(text="üì¢ ID –∫–∞–Ω–∞–ª–∞", callback_data="manage_channel_id")
    builder.button(text="üì¢ –Æ–∑–µ—Ä–Ω–µ–π–º –∫–∞–Ω–∞–ª–∞", callback_data="manage_channel_username")
    builder.button(text="üì¢ –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞", callback_data="manage_channel_name")
    builder.button(text="üí≥ –†–µ–∫–≤–∏–∑–∏—Ç—ã –æ–ø–ª–∞—Ç—ã", callback_data="manage_payment_details")
    builder.button(text="üéÅ –ù–∞–≥—Ä–∞–¥—ã –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏", callback_data="manage_rewards")
    builder.button(text="üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –±–æ—Ç–∞", callback_data="admin_restart_bot")
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_panel")
    builder.adjust(1)
    return builder.as_markup()

def get_payment_management_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="üí≥ –°–ë–ü", callback_data="manage_payment_sbp")
    builder.button(text="üí≥ –ö–∞—Ä—Ç–∞", callback_data="manage_payment_card")
    builder.button(text="üÖøÔ∏è Payeer", callback_data="manage_payment_payeer")
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_management")
    builder.adjust(1)
    return builder.as_markup()

def get_rewards_management_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="üìù –ü–æ—Å—Ç –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö", callback_data="manage_reward_post")
    builder.button(text="üé• –í–∏–¥–µ–æ-–æ–±–∑–æ—Ä", callback_data="manage_reward_video")
    builder.button(text="‚ú® –°—Ç–æ—Ä–∏—Å", callback_data="manage_reward_story")
    builder.button(text="‚≠ê –û—Ç–∑—ã–≤", callback_data="manage_reward_review")
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_management")
    builder.adjust(1)
    return builder.as_markup()

def get_back_to_settings_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_settings")
    return builder.as_markup()

def get_back_to_admin_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_panel")
    return builder.as_markup()

def get_back_to_management_keyboard():
    builder = InlineKeyboardBuilder()
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="admin_management")
    return builder.as_markup()

def get_payment_confirmation_keyboard(deposit_id):
    builder = InlineKeyboardBuilder()
    builder.button(text="‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–ª", callback_data=f"confirm_payment_{deposit_id}")
    builder.button(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="back_to_wallet")
    builder.adjust(1)
    return builder.as_markup()

def get_calc_keyboard(amount):
    builder = InlineKeyboardBuilder()
    builder.button(text="üí≥ –ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É —Å—É–º–º—É", callback_data=f"invest_calc_{amount}")
    builder.button(text="üîÑ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –µ—â–µ", callback_data="calc_again")
    builder.button(text="‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")
    builder.adjust(1)
    return builder.as_markup()

def get_withdrawal_actions_keyboard(withdrawal_id):
    builder = InlineKeyboardBuilder()
    builder.button(text="‚úÖ –û–¥–æ–±—Ä–∏—Ç—å", callback_data=f"approve_withdrawal_{withdrawal_id}")
    builder.button(text="‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"reject_withdrawal_{withdrawal_id}")
    builder.adjust(2)
    return builder.as_markup()

def get_deposit_actions_keyboard(deposit_id):
    builder = InlineKeyboardBuilder()
    builder.button(text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"approve_deposit_{deposit_id}")
    builder.button(text="‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"reject_deposit_{deposit_id}")
    builder.adjust(2)
    return builder.as_markup()

def get_support_actions_keyboard(request_id):
    builder = InlineKeyboardBuilder()
    builder.button(text="‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ", callback_data=f"approve_support_{request_id}")
    builder.button(text="‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"reject_support_{request_id}")
    builder.adjust(2)
    return builder.as_markup()

def get_reward_actions_keyboard(request_id):
    builder = InlineKeyboardBuilder()
    builder.button(text="‚úÖ –í—ã–ø–ª–∞—Ç–∏—Ç—å", callback_data=f"approve_reward_{request_id}")
    builder.button(text="‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"reject_reward_{request_id}")
    builder.adjust(2)
    return builder.as_markup()

# –ê–Ω–∏–º–∞—Ü–∏–∏
async def show_loading_animation(message, text, duration=2.0):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
    """
    try:
        loading_msg = await message.answer(text + " ‚è≥")
        await asyncio.sleep(duration)
        await loading_msg.delete()
    except Exception as e:
        print(f"Error in show_loading_animation: {e}")

# –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async def check_user_access(event):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∞)"""
    user_id = event.from_user.id
    user = db.get_user(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    if user and user[12]:  # is_blocked
        if isinstance(event, types.Message):
            await event.answer("üö´ –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.")
        else:
            await event.answer("üö´ –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.", show_alert=True)
        return False
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
    if user and not user[10]:  # has_subscribed
        is_subscribed = await check_subscription(user_id)
        if is_subscribed:
            db.update_subscription_status(user_id, True)
        else:
            text = f"""
<b>üì¢ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø –ü–û–î–ü–ò–°–ö–ê</b>

–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª:

<b>{REQUIRED_CHANNEL['name']}</b>

üëá <b>–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª –Ω–∏–∂–µ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è"</b>
            """
            if isinstance(event, types.Message):
                await event.answer(text, reply_markup=get_subscription_keyboard(), parse_mode="HTML")
            else:
                await event.message.answer(text, reply_markup=get_subscription_keyboard(), parse_mode="HTML")
            return False
    
    return True

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
@dp.message(Command("start"))
async def cmd_start(message: types.Message):
    user_id = message.from_user.id
    username = message.from_user.username
    first_name = message.from_user.first_name

    referral_id = None
    if len(message.text.split()) > 1:
        try:
            referral_id = int(message.text.split()[1])
        except ValueError:
            pass

    db.add_user(user_id, username, first_name, referral_id)

    is_subscribed = await check_subscription(user_id)
    if is_subscribed:
        db.update_subscription_status(user_id, True)

        welcome_text = f"""
<b>ü§ñ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {first_name}!</b>

üíº <b>–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–º –¥–æ—Ö–æ–¥–æ–º.</b>

üìà <b>–ù–∞—á–Ω–∏—Ç–µ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ–ª—É—á–∞–π—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å!</b>

üëá <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é:</b>
        """

        await message.answer(welcome_text, reply_markup=get_main_keyboard(), parse_mode="HTML")
    else:
        text = f"""
<b>üì¢ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø –ü–û–î–ü–ò–°–ö–ê</b>

–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–æ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª:

<b>{REQUIRED_CHANNEL['name']}</b>

üëá <b>–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª –Ω–∏–∂–µ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è"</b>
        """
        await message.answer(text, reply_markup=get_subscription_keyboard(), parse_mode="HTML")

@dp.message(Command("admin"))
async def cmd_admin(message: types.Message):
    if message.from_user.id != ADMIN_ID:
        await message.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω")
        return

    text = "<b>üë®‚Äçüíº –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    await message.answer(text, reply_markup=get_admin_keyboard(), parse_mode="HTML")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
@dp.callback_query(lambda c: c.data == "check_subscription")
async def check_subscription_callback(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    is_subscribed = await check_subscription(user_id)

    if is_subscribed:
        db.update_subscription_status(user_id, True)
        await callback.message.delete()

        welcome_text = f"""
<b>ü§ñ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {callback.from_user.first_name}!</b>

üíº <b>–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–º –¥–æ—Ö–æ–¥–æ–º.</b>

üìà <b>–ù–∞—á–Ω–∏—Ç–µ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ–ª—É—á–∞–π—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å!</b>

üëá <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é:</b>
        """

        await callback.message.answer(welcome_text, reply_markup=get_main_keyboard(), parse_mode="HTML")
    else:
        await callback.answer("‚ùå –í—ã –Ω–µ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª! –ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –∏ –Ω–∞–∂–º–∏—Ç–µ —Å–Ω–æ–≤–∞.", show_alert=True)

# –û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–µ–Ω—é
@dp.message(lambda message: message.text == "üñ• –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏")
async def investments_menu(message: types.Message):
    if not await check_user_access(message):
        return
        
    user_id = message.from_user.id

    if user_id in active_timers:
        active_timers[user_id] = False
        await asyncio.sleep(0.5)

    investment = db.get_active_investment(user_id)

    invested_amount = investment[2] if investment else 0.0
    accumulated_profit = calculate_accumulated_profit(investment) if investment else 0.0
    progress = get_accumulation_progress(investment) if investment else "0%"

    text = f"""
<b>‚ñ™Ô∏è –û—Ç–∫—Ä—ã–≤–∞–π –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ –ø–æ–ª—É—á–∞–π —Å—Ç–∞–±–∏–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å –≤ –¥–∞–Ω–Ω–æ–º —Ä–∞–∑–¥–µ–ª–µ, –ø–æ—Å–ª–µ —Å–æ–±–∏—Ä–∞–π –¥–æ—Ö–æ–¥:</b>

üí∞ <b>–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–±—ã–ª–∏:</b> {PROFIT_PERCENT}% –≤ —Å—É—Ç–∫–∏
‚è± <b>–í—Ä–µ–º—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è:</b> 24 —á–∞—Å–∞
üìÜ <b>–°—Ä–æ–∫ –≤–∫–ª–∞–¥–∞:</b> –ü–æ–∂–∏–∑–Ω–µ–Ω–Ω–æ

üí≥ <b>–í–∞—à –≤–∫–ª–∞–¥:</b> {invested_amount:.1f}‚ÇΩ
üíµ <b>–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ:</b> {accumulated_profit:.2f}‚ÇΩ

üìä <b>–ü—Ä–æ–≥—Ä–µ—Å—Å:</b> {progress}
üí° <b>–ú–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –æ—Ç {MIN_COLLECT}‚ÇΩ</b>
    """

    msg = await message.answer(text, reply_markup=get_investment_keyboard(), parse_mode="HTML")

    active_timers[user_id] = True
    asyncio.create_task(update_investment_progress(user_id, msg.message_id))

@dp.message(lambda message: message.text == "üëî –ü–∞—Ä—Ç–Ω—ë—Ä–∞–º")
async def partners_menu(message: types.Message):
    if not await check_user_access(message):
        return
        
    user_id = message.from_user.id
    user = db.get_user(user_id)

    ref_balance = user[4] if user else 0.0
    referrals_count = user[8] if user else 0
    ref_link = f"https://t.me/{BOT_USERNAME[1:]}?start={user_id}"

    text = f"""
<b>üëî –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>

üí∏ <b>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å:</b> {ref_balance:.2f}‚ÇΩ
üë• <b>–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤:</b> {referrals_count}

üîó <b>–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</b>
<code>{ref_link}</code>

üí∞ <b>–ë–æ–Ω—É—Å –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ:</b>
‚Ä¢ {REFERRAL_PERCENT_INVEST}% –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
‚Ä¢ {REFERRAL_PERCENT_WITHDRAW}% –æ—Ç –≤—ã–≤–æ–¥–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–∞

üìñ <b>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</b> –ö–∞–∫ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤?
    """

    await show_loading_animation(message, "üëî –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É...")
    await message.answer(text, reply_markup=get_partners_keyboard(), parse_mode="HTML")

@dp.message(lambda message: message.text == "üí≥ –ö–æ—à–µ–ª—ë–∫")
async def wallet_menu(message: types.Message):
    if not await check_user_access(message):
        return
        
    user_id = message.from_user.id
    user = db.get_user(user_id)

    balance = user[3] if user else 0.0
    ref_balance = user[4] if user else 0.0
    referrals_count = user[8] if user else 0

    text = f"""
<b>üÜî –í–∞—à ID:</b> {user_id}

üí∞ <b>–í–∞—à –±–∞–ª–∞–Ω—Å:</b> {balance:.2f}‚ÇΩ

üí≥ <b>–ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –±–∞–ª–∞–Ω—Å:</b> {ref_balance:.2f}‚ÇΩ
üë• <b>–ü–∞—Ä—Ç–Ω–µ—Ä–æ–≤:</b> {referrals_count} —á–µ–ª.
    """

    await show_loading_animation(message, "üí≥ –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–æ—à–µ–ª–µ–∫...")
    await message.answer(text, reply_markup=get_wallet_keyboard(), parse_mode="HTML")

@dp.message(lambda message: message.text == "üì† –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä")
async def calculator_menu(message: types.Message, state: FSMContext):
    if not await check_user_access(message):
        return
        
    text = f"""
<b>üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏</b>

–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞:

üíµ <b>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞:</b> 10‚ÇΩ
üìà <b>–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–∏–±—ã–ª—å:</b> {PROFIT_PERCENT}%
‚è± <b>–†–∞—Å—á–µ—Ç:</b> –∑–∞ 24 —á–∞—Å–∞
    """

    await show_loading_animation(message, "üìä –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä...")
    await message.answer(text, parse_mode="HTML")
    await state.set_state(UserStates.waiting_calc_amount)

@dp.message(UserStates.waiting_calc_amount)
async def process_calc_amount(message: types.Message, state: FSMContext):
    try:
        amount = float(message.text)
        if amount < 10:
            await message.answer("‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞: 10‚ÇΩ")
            return

        daily_profit = amount * PROFIT_PERCENT / 100
        weekly_profit = daily_profit * 7
        monthly_profit = daily_profit * 30

        text = f"""
<b>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞</b>

üíµ <b>–°—É–º–º–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏:</b> {amount:.2f}‚ÇΩ
üìà <b>–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–∏–±—ã–ª—å:</b> {PROFIT_PERCENT}%

üí∞ <b>–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å:</b>
‚Ä¢ –ó–∞ 24 —á–∞—Å–∞: {daily_profit:.2f}‚ÇΩ
‚Ä¢ –ó–∞ –Ω–µ–¥–µ–ª—é: {weekly_profit:.2f}‚ÇΩ
‚Ä¢ –ó–∞ –º–µ—Å—è—Ü: {monthly_profit:.2f}‚ÇΩ

üí° <b>–°–æ–≤–µ—Ç:</b> –†–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∏–±—ã–ª—å –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –¥–æ—Ö–æ–¥–∞!
        """

        await message.answer(text, reply_markup=get_calc_keyboard(amount), parse_mode="HTML")
        await state.clear()

    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É")

@dp.callback_query(lambda c: c.data == "calc_again")
async def calc_again_callback(callback: types.CallbackQuery, state: FSMContext):
    if not await check_user_access(callback):
        return
        
    text = f"""
<b>üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏</b>

–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞:

üíµ <b>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞:</b> 10‚ÇΩ
üìà <b>–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–∏–±—ã–ª—å:</b> {PROFIT_PERCENT}%
‚è± <b>–†–∞—Å—á–µ—Ç:</b> –∑–∞ 24 —á–∞—Å–∞
    """

    await callback.message.edit_text(text, parse_mode="HTML")
    await state.set_state(UserStates.waiting_calc_amount)

@dp.callback_query(lambda c: c.data.startswith("invest_calc_"))
async def invest_from_calc_callback(callback: types.CallbackQuery, state: FSMContext):
    if not await check_user_access(callback):
        return
        
    amount = float(callback.data.replace("invest_calc_", ""))
    user_id = callback.from_user.id
    user = db.get_user(user_id)
    balance = user[3] if user else 0.0

    if amount > balance:
        await callback.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ", show_alert=True)
        return

    if amount < MIN_DEPOSIT:
        await callback.answer(f"‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: {MIN_DEPOSIT}‚ÇΩ", show_alert=True)
        return

    db.add_investment(user_id, amount)
    db.update_balance(user_id, -amount)
    db.add_operation(user_id, "investment", amount)

    await callback.answer(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ {amount:.2f}‚ÇΩ", show_alert=True)

    investment = db.get_active_investment(user_id)
    invested_amount = investment[2] if investment else 0.0
    accumulated_profit = calculate_accumulated_profit(investment) if investment else 0.0
    progress = get_accumulation_progress(investment) if investment else "0%"

    text = f"""
<b>‚ñ™Ô∏è –û—Ç–∫—Ä—ã–≤–∞–π –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ –ø–æ–ª—É—á–∞–π —Å—Ç–∞–±–∏–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å –≤ –¥–∞–Ω–Ω–æ–º —Ä–∞–∑–¥–µ–ª–µ, –ø–æ—Å–ª–µ —Å–æ–±–∏—Ä–∞–π –¥–æ—Ö–æ–¥:</b>

üí∞ <b>–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–±—ã–ª–∏:</b> {PROFIT_PERCENT}% –≤ —Å—É—Ç–∫–∏
‚è± <b>–í—Ä–µ–º—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è:</b> 24 —á–∞—Å–∞
üìÜ <b>–°—Ä–æ–∫ –≤–∫–ª–∞–¥–∞:</b> –ü–æ–∂–∏–∑–Ω–µ–Ω–Ω–æ

üí≥ <b>–í–∞—à –≤–∫–ª–∞–¥:</b> {invested_amount:.1f}‚ÇΩ
üíµ <b>–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ:</b> {accumulated_profit:.2f}‚ÇΩ

üìä <b>–ü—Ä–æ–≥—Ä–µ—Å—Å:</b> {progress}
üí° <b>–ú–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –æ—Ç {MIN_COLLECT}‚ÇΩ</b>
    """

    await callback.message.edit_text(text, reply_markup=get_investment_keyboard(), parse_mode="HTML")

@dp.message(lambda message: message.text == "üìî –û–±—É—á–µ–Ω–∏–µ")
async def education_menu(message: types.Message):
    if not await check_user_access(message):
        return
        
    text = """
<b>üìî –û–±—É—á–µ–Ω–∏–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º</b>

üéØ <b>–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:</b>
‚Ä¢ –ò–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ç–æ–ª—å–∫–æ —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞
‚Ä¢ –î–∏–≤–µ—Ä—Å–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ –≤–ª–æ–∂–µ–Ω–∏—è
‚Ä¢ –†–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø—Ä–∏–±—ã–ª—å –¥–ª—è —Ä–æ—Å—Ç–∞

üí° <b>–°—Ç—Ä–∞—Ç–µ–≥–∏–∏:</b>
‚Ä¢ –ù–∞—á–∏–Ω–∞–π—Ç–µ —Å –Ω–µ–±–æ–ª—å—à–∏—Ö —Å—É–º–º
‚Ä¢ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É

üìö <b>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã:</b>
‚Ä¢ –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –Ω–∞—à–µ–º –∫–∞–Ω–∞–ª–µ
‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã —É—Å–ø–µ—à–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
‚Ä¢ –°–æ–≤–µ—Ç—ã –æ—Ç –æ–ø—ã—Ç–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤
    """

    await show_loading_animation(message, "üìî –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ...")
    await message.answer(text, parse_mode="HTML")

@dp.message(lambda message: message.text == "üÜò –ü–æ–º–æ—â—å –≤ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–∏")
async def promotion_help_menu(message: types.Message):
    if not await check_user_access(message):
        return
        
    text = f"""
<b>üÜò –ü–æ–º–æ—â—å –≤ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–∏ –±–æ—Ç–∞</b>

üí∞ <b>–ü–æ–ª—É—á–∞–π—Ç–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å!</b>

üéØ <b>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è:</b>
‚Ä¢ üìù –ü–æ—Å—Ç –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö - {REWARD_PRICES['post']}‚ÇΩ
‚Ä¢ üé• –í–∏–¥–µ–æ-–æ–±–∑–æ—Ä - {REWARD_PRICES['video']}‚ÇΩ
‚Ä¢ ‚ú® –°—Ç–æ—Ä–∏—Å - {REWARD_PRICES['story']}‚ÇΩ
‚Ä¢ ‚≠ê –û—Ç–∑—ã–≤ - {REWARD_PRICES['review']}‚ÇΩ

üìã <b>–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É:</b>
1. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–¥–∞–Ω–∏—è
2. –°–¥–µ–ª–∞–π—Ç–µ –ø–æ—Å—Ç/–≤–∏–¥–µ–æ/—Å—Ç–æ—Ä–∏—Å/–æ—Ç–∑—ã–≤
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ
4. –ü–æ–ª—É—á–∏—Ç–µ –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
5. –í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –ø–æ—Å—Ç—É–ø–∏—Ç –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å

üëá <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–¥–∞–Ω–∏—è:</b>
    """

    await show_loading_animation(message, "üÜò –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞–Ω–∏—è...")
    await message.answer(text, reply_markup=get_promotion_keyboard(), parse_mode="HTML")

@dp.message(lambda message: message.text == "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
async def settings_menu(message: types.Message):
    if not await check_user_access(message):
        return
        
    days_working = get_days_working()
    total_investors = db.get_active_investors_count()
    new_investors_24h = db.get_new_users_last_24h()
    online_now = db.get_online_users_count()

    text = f"""
<b>‚ñ™Ô∏è –í—ã –ø–æ–ø–∞–ª–∏ –≤ —Ä–∞–∑–¥–µ–ª –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞, –∑–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –∞ —Ç–∞–∫–∂–µ —É–∑–Ω–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.</b>

üåê <b>–î–Ω–µ–π —Ä–∞–±–æ—Ç–∞–µ–º:</b> {days_working}
‚ñ™Ô∏è <b>–í—Å–µ–≥–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤:</b> {total_investors}
‚ñ™Ô∏è <b>–ù–æ–≤—ã—Ö –∑–∞ 24 —á–∞—Å–∞:</b> {new_investors_24h}
‚ñ™Ô∏è <b>–û–Ω–ª–∞–π–Ω:</b> {online_now}
    """

    await show_loading_animation(message, "‚öôÔ∏è –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏...")
    await message.answer(text, reply_markup=get_settings_keyboard(), parse_mode="HTML")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
@dp.callback_query(lambda c: c.data == "invest")
async def invest_callback(callback: types.CallbackQuery, state: FSMContext):
    if not await check_user_access(callback):
        return
        
    user_id = callback.from_user.id
    user = db.get_user(user_id)
    balance = user[3] if user else 0.0

    text = f"""
<b>üí≥ –ò–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</b>

üí∞ <b>–í–∞—à –±–∞–ª–∞–Ω—Å:</b> {balance:.2f}‚ÇΩ
üíµ <b>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞:</b> {MIN_DEPOSIT}‚ÇΩ

–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
    """

    await callback.message.edit_text(text, parse_mode="HTML")
    await state.set_state(UserStates.waiting_invest_amount)

@dp.message(UserStates.waiting_invest_amount)
async def process_invest_amount(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    user = db.get_user(user_id)
    balance = user[3] if user else 0.0

    try:
        amount = float(message.text)
        if amount < MIN_DEPOSIT:
            await message.answer(f"‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: {MIN_DEPOSIT}‚ÇΩ")
            return
        if amount > balance:
            await message.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ")
            return

        db.add_investment(user_id, amount)
        db.update_balance(user_id, -amount)
        db.add_operation(user_id, "investment", amount)

        await message.answer(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ {amount:.2f}‚ÇΩ")
        await state.clear()

    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–°–æ–±—Ä–∞—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è"
@dp.callback_query(lambda c: c.data == "collect")
async def collect_callback(callback: types.CallbackQuery):
    if not await check_user_access(callback):
        return
        
    user_id = callback.from_user.id
    investment = db.get_active_investment(user_id)

    if not investment:
        await callback.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π", show_alert=True)
        return

    accumulated_profit = calculate_accumulated_profit(investment)

    if accumulated_profit < MIN_COLLECT:
        await callback.answer(f"‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è —Å–±–æ—Ä–∞: {MIN_COLLECT}‚ÇΩ. –ù–∞–∫–æ–ø–ª–µ–Ω–æ: {accumulated_profit:.2f}‚ÇΩ", show_alert=True)
        return

    db.update_balance(user_id, accumulated_profit)
    db.add_operation(user_id, "profit_collection", accumulated_profit)
    db.reset_investment_accumulated(investment[0])

    cursor = db.conn.cursor()
    cursor.execute(
        'UPDATE users SET total_earned = total_earned + ? WHERE user_id = ?',
        (accumulated_profit, user_id)
    )
    db.conn.commit()

    await callback.answer(f"‚úÖ –°–æ–±—Ä–∞–Ω–æ {accumulated_profit:.2f}‚ÇΩ –ø—Ä–∏–±—ã–ª–∏!", show_alert=True)

    investment = db.get_active_investment(user_id)
    invested_amount = investment[2] if investment else 0.0
    new_accumulated = 0.0
    progress = "0%"

    text = f"""
<b>‚ñ™Ô∏è –û—Ç–∫—Ä—ã–≤–∞–π –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ –ø–æ–ª—É—á–∞–π —Å—Ç–∞–±–∏–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å –≤ –¥–∞–Ω–Ω–æ–º —Ä–∞–∑–¥–µ–ª–µ, –ø–æ—Å–ª–µ —Å–æ–±–∏—Ä–∞–π –¥–æ—Ö–æ–¥:</b>

üí∞ <b>–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∏–±—ã–ª–∏:</b> {PROFIT_PERCENT}% –≤ —Å—É—Ç–∫–∏
‚è± <b>–í—Ä–µ–º—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è:</b> 24 —á–∞—Å–∞
üìÜ <b>–°—Ä–æ–∫ –≤–∫–ª–∞–¥–∞:</b> –ü–æ–∂–∏–∑–Ω–µ–Ω–Ω–æ

üí≥ <b>–í–∞—à –≤–∫–ª–∞–¥:</b> {invested_amount:.1f}‚ÇΩ
üíµ <b>–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ:</b> {new_accumulated:.2f}‚ÇΩ

üìä <b>–ü—Ä–æ–≥—Ä–µ—Å—Å:</b> {progress}
üí° <b>–ú–æ–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –æ—Ç {MIN_COLLECT}‚ÇΩ</b>
    """

    await callback.message.edit_text(text, reply_markup=get_investment_keyboard(), parse_mode="HTML")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ—à–µ–ª—å–∫–∞
@dp.callback_query(lambda c: c.data == "deposit")
async def deposit_callback(callback: types.CallbackQuery):
    if not await check_user_access(callback):
        return
        
    text = """
<b>üì• –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</b>

–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:

üí≥ <b>–°–ë–ü</b> - –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ
üí≥ <b>–ö–∞—Ä—Ç–∞</b> - –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É
üÖøÔ∏è <b>Payeer</b> - –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
üë®‚Äçüíº <b>–†—É—á–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</b> - —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    """

    await callback.message.edit_text(text, reply_markup=get_deposit_methods_keyboard(), parse_mode="HTML")

@dp.callback_query(lambda c: c.data == "withdraw")
async def withdraw_callback(callback: types.CallbackQuery):
    if not await check_user_access(callback):
        return
        
    user_id = callback.from_user.id
    user = db.get_user(user_id)
    balance = user[3] if user else 0.0

    text = f"""
<b>üì§ –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</b>

üí∞ <b>–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –≤—ã–≤–æ–¥–∞:</b> {balance:.2f}‚ÇΩ
üíµ <b>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞:</b> {MIN_WITHDRAWAL}‚ÇΩ

–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—ã–≤–æ–¥–∞:
    """

    await callback.message.edit_text(text, reply_markup=get_withdraw_methods_keyboard(), parse_mode="HTML")

@dp.callback_query(lambda c: c.data == "reinvest")
async def reinvest_callback(callback: types.CallbackQuery):
    if not await check_user_access(callback):
        return
        
    user_id = callback.from_user.id
    user = db.get_user(user_id)
    balance = user[3] if user else 0.0

    if balance < MIN_DEPOSIT:
        await callback.answer(f"‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è —Ä–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {MIN_DEPOSIT}‚ÇΩ", show_alert=True)
        return

    db.add_investment(user_id, balance)
    db.update_balance(user_id, -balance)
    db.add_operation(user_id, "reinvestment", balance)

    await callback.answer(f"‚úÖ –£—Å–ø–µ—à–Ω–æ —Ä–µ–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ {balance:.2f}‚ÇΩ", show_alert=True)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
@dp.callback_query(lambda c: c.data.startswith("deposit_"))
async def deposit_method_callback(callback: types.CallbackQuery, state: FSMContext):
    if not await check_user_access(callback):
        return
        
    method = callback.data.replace("deposit_", "")
    await state.update_data(deposit_method=method)

    if method == "manual":
        text = f"""
<b>üë®‚Äçüíº –†—É—á–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</b>

–î–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º:
{SUPPORT_USERNAME}

–£–∫–∞–∂–∏—Ç–µ:
1. –°—É–º–º—É –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
2. –í–∞—à ID: <code>{callback.from_user.id}</code>
3. –°–∫—Ä–∏–Ω—à–æ—Ç –æ–ø–ª–∞—Ç—ã
        """
        await callback.message.edit_text(text, parse_mode="HTML")
    else:
        text = f"""
<b>üí≥ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</b>

üí≥ <b>–°–ø–æ—Å–æ–±:</b> {method.upper()}
üíµ <b>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞:</b> {MIN_DEPOSIT}‚ÇΩ

–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:
        """
        await callback.message.edit_text(text, parse_mode="HTML")
        await state.set_state(UserStates.waiting_deposit_amount)

@dp.message(UserStates.waiting_deposit_amount)
async def process_deposit_amount(message: types.Message, state: FSMContext):
    try:
        amount = float(message.text)
        if amount < MIN_DEPOSIT:
            await message.answer(f"‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è: {MIN_DEPOSIT}‚ÇΩ")
            return

        data = await state.get_data()
        method = data.get('deposit_method')

        if method in ["sbp", "card", "payeer"]:
            details = ""
            if method == "sbp":
                details = f"""
<b>üí≥ –†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã –ø–æ –°–ë–ü:</b>

üè¶ <b>–ë–∞–Ω–∫:</b> {PAYMENT_DETAILS['sbp']['bank']}
üì± <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> {PAYMENT_DETAILS['sbp']['phone']}
üë§ <b>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</b> {PAYMENT_DETAILS['sbp']['recipient']}

üí° <b>–í –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É–∫–∞–∂–∏—Ç–µ:</b> –≤–∞—à ID
                """
            elif method == "card":
                details = f"""
<b>üí≥ –†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã –Ω–∞ –∫–∞—Ä—Ç—É:</b>

üè¶ <b>–ë–∞–Ω–∫:</b> {PAYMENT_DETAILS['card']['bank']}
üí≥ <b>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã:</b> {PAYMENT_DETAILS['card']['card_number']}
üë§ <b>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</b> {PAYMENT_DETAILS['card']['recipient']}

üí° <b>–í –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É–∫–∞–∂–∏—Ç–µ:</b> –≤–∞—à ID
                """
            else:  # payeer
                details = f"""
<b>üÖøÔ∏è –†–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ Payeer:</b>

üë§ <b>–ê–∫–∫–∞—É–Ω—Ç:</b> {PAYMENT_DETAILS['payeer']['account']}
üíº <b>–ö–æ—à–µ–ª–µ–∫:</b> {PAYMENT_DETAILS['payeer']['wallet']}
üîó <b>–°—Å—ã–ª–∫–∞:</b> {PAYMENT_DETAILS['payeer']['link']}

üí° <b>–í –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —É–∫–∞–∂–∏—Ç–µ:</b> –≤–∞—à ID
                """

            deposit_id = db.add_deposit_request(message.from_user.id, amount, method)

            text = f"""
{details}

üíµ <b>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ:</b> {amount}‚ÇΩ
üÜî <b>–í–∞—à ID –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</b> <code>{message.from_user.id}</code>

üëá <b>–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–Ø –æ–ø–ª–∞—Ç–∏–ª"</b>
            """

            await message.answer(text, reply_markup=get_payment_confirmation_keyboard(deposit_id), parse_mode="HTML")

        await state.clear()

    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã
@dp.callback_query(lambda c: c.data.startswith("confirm_payment_"))
async def confirm_payment_callback(callback: types.CallbackQuery):
    deposit_id = int(callback.data.replace("confirm_payment_", ""))
    deposit = db.get_deposit_by_id(deposit_id)

    if deposit:
        admin_text = f"""
<b>üì• –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ #{deposit_id}</b>

üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {callback.from_user.first_name} (@{callback.from_user.username})
üÜî <b>ID:</b> {deposit[1]}
üíµ <b>–°—É–º–º–∞:</b> {deposit[2]}‚ÇΩ
üí≥ <b>–°–ø–æ—Å–æ–±:</b> {deposit[3]}

‚è∞ <b>–í—Ä–µ–º—è:</b> {deposit[5]}
        """

        await bot.send_message(ADMIN_ID, admin_text, reply_markup=get_deposit_actions_keyboard(deposit_id), parse_mode="HTML")

        await callback.message.edit_text(
            "‚úÖ <b>–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</b>\n\n–û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã.",
            parse_mode="HTML"
        )
        await callback.answer("‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É", show_alert=True)
    else:
        await callback.answer("‚ùå –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤—ã–≤–æ–¥–∞
@dp.callback_query(lambda c: c.data.startswith("withdraw_"))
async def withdraw_method_callback(callback: types.CallbackQuery, state: FSMContext):
    if not await check_user_access(callback):
        return
        
    method = callback.data.replace("withdraw_", "")
    await state.update_data(withdraw_method=method)

    user_id = callback.from_user.id
    user = db.get_user(user_id)
    balance = user[3] if user else 0.0

    if balance < MIN_WITHDRAWAL:
        await callback.answer(f"‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: {MIN_WITHDRAWAL}‚ÇΩ", show_alert=True)
        return

    text = f"""
<b>üì§ –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</b>

üí∞ <b>–î–æ—Å—Ç—É–ø–Ω–æ:</b> {balance:.2f}‚ÇΩ
üíµ <b>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞:</b> {MIN_WITHDRAWAL}‚ÇΩ

–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –≤—ã–≤–æ–¥–∞:
    """

    await callback.message.edit_text(text, parse_mode="HTML")
    await state.set_state(UserStates.waiting_withdraw_amount)

@dp.message(UserStates.waiting_withdraw_amount)
async def process_withdraw_amount(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    user = db.get_user(user_id)
    balance = user[3] if user else 0.0

    try:
        amount = float(message.text)
        if amount < MIN_WITHDRAWAL:
            await message.answer(f"‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –≤—ã–≤–æ–¥–∞: {MIN_WITHDRAWAL}‚ÇΩ")
            return
        if amount > balance:
            await message.answer("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ")
            return

        data = await state.get_data()
        method = data.get('withdraw_method')

        text = f"""
<b>üì§ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∞</b>

üíµ <b>–°—É–º–º–∞:</b> {amount}‚ÇΩ
üí≥ <b>–°–ø–æ—Å–æ–±:</b> {method}

–í–≤–µ–¥–∏—Ç–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –≤—ã–≤–æ–¥–∞:
        """

        await message.answer(text, parse_mode="HTML")
        await state.update_data(withdraw_amount=amount)
        await state.set_state(UserStates.waiting_withdraw_method)

    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É")

@dp.message(UserStates.waiting_withdraw_method)
async def process_withdraw_details(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    data = await state.get_data()
    amount = data.get('withdraw_amount')
    method = data.get('withdraw_method')
    details = message.text

    withdrawal_id = db.add_withdrawal_request(user_id, amount, method, details)
    db.update_balance(user_id, -amount)
    db.add_operation(user_id, "withdrawal_request", amount)

    await message.answer(f"‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ {amount}‚ÇΩ —Å–æ–∑–¥–∞–Ω–∞. –û–∂–∏–¥–∞–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.")

    admin_text = f"""
<b>üì§ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ #{withdrawal_id}</b>

üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {message.from_user.first_name} (@{message.from_user.username})
üÜî <b>ID:</b> {user_id}
üíµ <b>–°—É–º–º–∞:</b> {amount}‚ÇΩ
üí≥ <b>–°–ø–æ—Å–æ–±:</b> {method}
üìã <b>–†–µ–∫–≤–∏–∑–∏—Ç—ã:</b> {details}
    """

    await bot.send_message(ADMIN_ID, admin_text, reply_markup=get_withdrawal_actions_keyboard(withdrawal_id), parse_mode="HTML")

    await state.clear()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
@dp.callback_query(lambda c: c.data == "statistics")
async def statistics_callback(callback: types.CallbackQuery):
    if not await check_user_access(callback):
        return
        
    total_users = db.get_users_count()
    active_investors = db.get_active_investors_count()
    new_users_24h = db.get_new_users_last_24h()
    online_now = db.get_online_users_count()
    total_invested = db.get_total_invested()
    total_earned = db.get_total_earned()
    days_working = get_days_working()

    text = f"""
<b>üìä –†–µ–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞:</b>

üë• <b>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</b> {total_users}
üí∞ <b>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤:</b> {active_investors}
üÜï <b>–ù–æ–≤—ã—Ö –∑–∞ 24 —á–∞—Å–∞:</b> {new_users_24h}
üåê <b>–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å:</b> {online_now}

üíµ <b>–û–±—â–∞—è —Å—É–º–º–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π:</b> {total_invested:.2f}‚ÇΩ
üéØ <b>–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</b> {total_earned:.2f}‚ÇΩ
üìÖ <b>–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç:</b> {days_working} –¥–Ω–µ–π
    """

    await callback.message.edit_text(text, reply_markup=get_back_to_settings_keyboard(), parse_mode="HTML")

@dp.callback_query(lambda c: c.data == "operations")
async def operations_callback(callback: types.CallbackQuery):
    if not await check_user_access(callback):
        return
        
    operations = db.get_recent_operations(10)

    if not operations:
        text = "üìã <b>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:</b>\n\n–û–ø–µ—Ä–∞—Ü–∏–π –ø–æ–∫–∞ –Ω–µ—Ç"
    else:
        text = "üìã <b>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:</b>\n\n"
        for op in operations:
            text += f"‚Ä¢ {op[1]}: {op[2]}‚ÇΩ\n"

    await callback.message.edit_text(text, reply_markup=get_back_to_settings_keyboard(), parse_mode="HTML")

@dp.callback_query(lambda c: c.data == "notifications")
async def notifications_callback(callback: types.CallbackQuery):
    if not await check_user_access(callback):
        return
        
    user_id = callback.from_user.id
    user = db.get_user(user_id)
    notifications_enabled = user[9] if user else 1

    if notifications_enabled:
        db.update_notifications(user_id, False)
        status = "‚ùå –û—Ç–∫–ª—é—á–µ–Ω—ã"
    else:
        db.update_notifications(user_id, True)
        status = "‚úÖ –í–∫–ª—é—á–µ–Ω—ã"

    text = f"""
<b>üîî –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</b>

–°—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: {status}

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–∞—é—Ç:
‚Ä¢ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ —Å–±–æ—Ä–µ –ø—Ä–∏–±—ã–ª–∏
‚Ä¢ –ù–æ–≤–æ—Å—Ç–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
‚Ä¢ –ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–µ –±–æ–Ω—É—Å—ã
    """

    await callback.message.edit_text(text, reply_markup=get_back_to_settings_keyboard(), parse_mode="HTML")

@dp.callback_query(lambda c: c.data == "support")
async def support_callback(callback: types.CallbackQuery, state: FSMContext):
    if not await check_user_access(callback):
        return
        
    text = """
<b>üÜò –°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</b>

–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –∏–ª–∏ –≤–æ–ø—Ä–æ—Å:

üí° <b>–ü—Ä–∏–º–µ—Ä—ã:</b>
‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º/–≤—ã–≤–æ–¥–æ–º
‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–ø–æ–ª–∞–¥–∫–∏
‚Ä¢ –í–æ–ø—Ä–æ—Å—ã –ø–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º
‚Ä¢ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é
    """

    await callback.message.edit_text(text, parse_mode="HTML")
    await state.set_state(UserStates.waiting_support_message)

@dp.message(UserStates.waiting_support_message)
async def process_support_message(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    support_id = db.add_support_request(user_id, message.text)

    admin_text = f"""
<b>üÜò –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É #{support_id}</b>

üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {message.from_user.first_name} (@{message.from_user.username})
üÜî <b>ID:</b> {user_id}

üìù <b>–°–æ–æ–±—â–µ–Ω–∏–µ:</b>
{message.text}
    """

    await bot.send_message(ADMIN_ID, admin_text, reply_markup=get_support_actions_keyboard(support_id), parse_mode="HTML")

    await message.answer("‚úÖ –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É. –ú—ã –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.")
    await state.clear()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–≥—Ä–∞–¥ –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
@dp.callback_query(lambda c: c.data.startswith("reward_"))
async def reward_type_callback(callback: types.CallbackQuery, state: FSMContext):
    if not await check_user_access(callback):
        return
        
    reward_type = callback.data.replace("reward_", "")
    await state.update_data(reward_type=reward_type)

    reward_names = {
        "post": "üìù –ü–æ—Å—Ç –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö",
        "video": "üé• –í–∏–¥–µ–æ-–æ–±–∑–æ—Ä",
        "story": "‚ú® –°—Ç–æ—Ä–∏—Å",
        "review": "‚≠ê –û—Ç–∑—ã–≤"
    }

    text = f"""
<b>{reward_names[reward_type]}</b>

üí∞ <b>–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ:</b> {REWARD_PRICES[reward_type]}‚ÇΩ

üìã <b>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:</b>
‚Ä¢ –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞
‚Ä¢ –°—Å—ã–ª–∫–∞ –Ω–∞ –±–æ—Ç–∞: https://t.me/{BOT_USERNAME[1:]}
‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç

üìù <b>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞—à {reward_names[reward_type].lower()} –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ:</b>
    """

    await callback.message.edit_text(text, parse_mode="HTML")
    await state.set_state(UserStates.waiting_reward_proof)

@dp.message(UserStates.waiting_reward_proof)
async def process_reward_proof(message: types.Message, state: FSMContext):
    data = await state.get_data()
    reward_type = data.get('reward_type')
    proof_text = message.text

    reward_names = {
        "post": "–ø–æ—Å—Ç –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö",
        "video": "–≤–∏–¥–µ–æ-–æ–±–∑–æ—Ä",
        "story": "—Å—Ç–æ—Ä–∏—Å",
        "review": "–æ—Ç–∑—ã–≤"
    }

    reward_id = db.add_reward_request(
        message.from_user.id,
        reward_type,
        proof_text,
        REWARD_PRICES[reward_type]
    )

    admin_text = f"""
<b>üéÅ –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –Ω–∞–≥—Ä–∞–¥—É #{reward_id}</b>

üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {message.from_user.first_name} (@{message.from_user.username})
üÜî <b>ID:</b> {message.from_user.id}
üéØ <b>–¢–∏–ø:</b> {reward_names[reward_type]}
üí∞ <b>–°—É–º–º–∞:</b> {REWARD_PRICES[reward_type]}‚ÇΩ

üìù <b>–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:</b>
{proof_text}
    """

    await bot.send_message(ADMIN_ID, admin_text, reply_markup=get_reward_actions_keyboard(reward_id), parse_mode="HTML")

    await message.answer(f"‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –Ω–∞–≥—Ä–∞–¥—É –∑–∞ {reward_names[reward_type]} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
    await state.clear()

# –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
@dp.callback_query(lambda c: c.data == "admin_panel")
async def admin_panel_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    text = "<b>üë®‚Äçüíº –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    await callback.message.edit_text(text, reply_markup=get_admin_keyboard(), parse_mode="HTML")

@dp.callback_query(lambda c: c.data == "admin_stats")
async def admin_stats_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    total_users = db.get_users_count()
    active_investors = db.get_active_investors_count()
    new_users_24h = db.get_new_users_last_24h()
    online_now = db.get_online_users_count()
    total_invested = db.get_total_invested()
    total_earned = db.get_total_earned()
    days_working = get_days_working()

    pending_deposits = len(db.get_pending_deposits())
    pending_withdrawals = len(db.get_pending_withdrawals())
    pending_support = len(db.get_pending_support_requests())
    pending_rewards = len(db.get_pending_reward_requests())

    text = f"""
<b>üìä –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</b>

üë• <b>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</b> {total_users}
üí∞ <b>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤:</b> {active_investors}
üÜï <b>–ù–æ–≤—ã—Ö –∑–∞ 24 —á–∞—Å–∞:</b> {new_users_24h}
üåê <b>–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å:</b> {online_now}

üíµ <b>–û–±—â–∞—è —Å—É–º–º–∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π:</b> {total_invested:.2f}‚ÇΩ
üéØ <b>–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</b> {total_earned:.2f}‚ÇΩ
üìÖ <b>–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç:</b> {days_working} –¥–Ω–µ–π

üì• <b>–ó–∞—è–≤–æ–∫ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ:</b> {pending_deposits}
üì§ <b>–ó–∞—è–≤–æ–∫ –Ω–∞ –≤—ã–≤–æ–¥:</b> {pending_withdrawals}
üÜò <b>–ó–∞—è–≤–æ–∫ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É:</b> {pending_support}
üéÅ <b>–ó–∞—è–≤–æ–∫ –Ω–∞ –Ω–∞–≥—Ä–∞–¥—ã:</b> {pending_rewards}
    """

    await callback.message.edit_text(text, reply_markup=get_back_to_admin_keyboard(), parse_mode="HTML")

@dp.callback_query(lambda c: c.data == "admin_withdrawals")
async def admin_withdrawals_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    withdrawals = db.get_pending_withdrawals()

    if not withdrawals:
        text = "üìã <b>–ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥:</b>\n\n–ó–∞—è–≤–æ–∫ –Ω–µ—Ç"
        await callback.message.edit_text(text, reply_markup=get_back_to_admin_keyboard(), parse_mode="HTML")
        return

    text = "üìã <b>–ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥:</b>\n\n"
    for w in withdrawals:
        text += f"üÜî <b>ID –∑–∞—è–≤–∫–∏:</b> {w[0]}\n"
        text += f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {w[7]} (@{w[6]})\n"
        text += f"üíµ <b>–°—É–º–º–∞:</b> {w[2]}‚ÇΩ\n"
        text += f"üí≥ <b>–°–ø–æ—Å–æ–±:</b> {w[3]}\n"
        text += f"üìã <b>–†–µ–∫–≤–∏–∑–∏—Ç—ã:</b> {w[4]}\n"
        text += f"‚è∞ <b>–í—Ä–µ–º—è:</b> {w[5]}\n"
        text += "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"

    await callback.message.edit_text(text, reply_markup=get_back_to_admin_keyboard(), parse_mode="HTML")

@dp.callback_query(lambda c: c.data == "admin_deposit_requests")
async def admin_deposit_requests_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    deposits = db.get_pending_deposits()

    if not deposits:
        text = "üì• <b>–ó–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ:</b>\n\n–ó–∞—è–≤–æ–∫ –Ω–µ—Ç"
        await callback.message.edit_text(text, reply_markup=get_back_to_admin_keyboard(), parse_mode="HTML")
        return

    text = "üì• <b>–ó–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ:</b>\n\n"
    for d in deposits:
        text += f"üÜî <b>ID –∑–∞—è–≤–∫–∏:</b> {d[0]}\n"
        text += f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {d[4]} (@{d[3]})\n"
        text += f"üíµ <b>–°—É–º–º–∞:</b> {d[2]}‚ÇΩ\n"
        text += f"üí≥ <b>–°–ø–æ—Å–æ–±:</b> {d[3]}\n"
        text += f"‚è∞ <b>–í—Ä–µ–º—è:</b> {d[5]}\n"
        text += "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"

    await callback.message.edit_text(text, reply_markup=get_back_to_admin_keyboard(), parse_mode="HTML")

@dp.callback_query(lambda c: c.data == "admin_support_requests")
async def admin_support_requests_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    support_requests = db.get_pending_support_requests()

    if not support_requests:
        text = "üÜò <b>–ó–∞—è–≤–∫–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É:</b>\n\n–ó–∞—è–≤–æ–∫ –Ω–µ—Ç"
        await callback.message.edit_text(text, reply_markup=get_back_to_admin_keyboard(), parse_mode="HTML")
        return

    text = "üÜò <b>–ó–∞—è–≤–∫–∏ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É:</b>\n\n"
    for sr in support_requests:
        text += f"üÜî <b>ID –∑–∞—è–≤–∫–∏:</b> {sr[0]}\n"
        text += f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {sr[4]} (@{sr[3]})\n"
        text += f"üìù <b>–°–æ–æ–±—â–µ–Ω–∏–µ:</b> {sr[2][:100]}...\n"
        text += f"‚è∞ <b>–í—Ä–µ–º—è:</b> {sr[5]}\n"
        text += "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"

    await callback.message.edit_text(text, reply_markup=get_back_to_admin_keyboard(), parse_mode="HTML")

@dp.callback_query(lambda c: c.data == "admin_reward_requests")
async def admin_reward_requests_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    reward_requests = db.get_pending_reward_requests()

    if not reward_requests:
        text = "üéÅ <b>–ó–∞—è–≤–∫–∏ –Ω–∞ –Ω–∞–≥—Ä–∞–¥—ã:</b>\n\n–ó–∞—è–≤–æ–∫ –Ω–µ—Ç"
        await callback.message.edit_text(text, reply_markup=get_back_to_admin_keyboard(), parse_mode="HTML")
        return

    reward_names = {
        "post": "üìù –ü–æ—Å—Ç",
        "video": "üé• –í–∏–¥–µ–æ",
        "story": "‚ú® –°—Ç–æ—Ä–∏—Å",
        "review": "‚≠ê –û—Ç–∑—ã–≤"
    }

    text = "üéÅ <b>–ó–∞—è–≤–∫–∏ –Ω–∞ –Ω–∞–≥—Ä–∞–¥—ã:</b>\n\n"
    for rr in reward_requests:
        text += f"üÜî <b>ID –∑–∞—è–≤–∫–∏:</b> {rr[0]}\n"
        text += f"üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> {rr[5]} (@{rr[4]})\n"
        text += f"üéØ <b>–¢–∏–ø:</b> {reward_names.get(rr[2], rr[2])}\n"
        text += f"üí∞ <b>–°—É–º–º–∞:</b> {rr[4]}‚ÇΩ\n"
        text += f"üìù <b>–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ:</b> {rr[3][:50]}...\n"
        text += f"‚è∞ <b>–í—Ä–µ–º—è:</b> {rr[6]}\n"
        text += "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"

    await callback.message.edit_text(text, reply_markup=get_back_to_admin_keyboard(), parse_mode="HTML")

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
@dp.callback_query(lambda c: c.data == "admin_user_management")
async def admin_user_management_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    text = """
<b>üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</b>

–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:

‚Ä¢ ‚ùÑÔ∏è –ó–∞–º–æ—Ä–æ–∑–∏—Ç—å –±–∞–ª–∞–Ω—Å - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–º–æ–∂–µ—Ç –≤—ã–≤–æ–¥–∏—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞
‚Ä¢ üî• –†–∞–∑–º–æ—Ä–æ–∑–∏—Ç—å –±–∞–ª–∞–Ω—Å - —Å–Ω—è—Ç—å –∑–∞–º–æ—Ä–æ–∑–∫—É
‚Ä¢ üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –ø–æ–ª–Ω—ã–π –∑–∞–ø—Ä–µ—Ç –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞
‚Ä¢ ‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - —Å–Ω—è—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
    """

    await callback.message.edit_text(text, reply_markup=get_user_management_keyboard(), parse_mode="HTML")

# –ó–∞–º–æ—Ä–æ–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
@dp.callback_query(lambda c: c.data == "admin_freeze_user")
async def admin_freeze_user_callback(callback: types.CallbackQuery, state: FSMContext):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    text = "‚ùÑÔ∏è <b>–ó–∞–º–æ—Ä–æ–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞</b>\n\n–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
    await callback.message.edit_text(text, parse_mode="HTML")
    await state.set_state(AdminStates.waiting_freeze_user_id)

@dp.message(AdminStates.waiting_freeze_user_id)
async def process_freeze_user_id(message: types.Message, state: FSMContext):
    try:
        user_id = int(message.text)
        user = db.get_user(user_id)
        if not user:
            await message.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return

        await state.update_data(freeze_user_id=user_id)
        await message.answer(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user[2]}\nüìù –í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∑–∞–º–æ—Ä–æ–∑–∫–∏:")
        await state.set_state(AdminStates.waiting_freeze_reason)

    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")

@dp.message(AdminStates.waiting_freeze_reason)
async def process_freeze_reason(message: types.Message, state: FSMContext):
    data = await state.get_data()
    user_id = data.get('freeze_user_id')
    reason = message.text

    db.freeze_user(user_id, reason)

    await message.answer(f"‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –∑–∞–º–æ—Ä–æ–∂–µ–Ω\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}")

    try:
        await bot.send_message(
            user_id,
            f"‚ùÑÔ∏è –í–∞—à –±–∞–ª–∞–Ω—Å –±—ã–ª –∑–∞–º–æ—Ä–æ–∂–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}\n\n–î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
        )
    except Exception:
        pass

    await state.clear()

# –†–∞–∑–º–æ—Ä–æ–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞
@dp.callback_query(lambda c: c.data == "admin_unfreeze_user")
async def admin_unfreeze_user_callback(callback: types.CallbackQuery, state: FSMContext):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    text = "üî• <b>–†–∞–∑–º–æ—Ä–æ–∑–∫–∞ –±–∞–ª–∞–Ω—Å–∞</b>\n\n–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
    await callback.message.edit_text(text, parse_mode="HTML")
    await state.set_state(AdminStates.waiting_freeze_user_id)

@dp.message(AdminStates.waiting_freeze_user_id)
async def process_unfreeze_user_id(message: types.Message, state: FSMContext):
    try:
        user_id = int(message.text)
        user = db.get_user(user_id)
        if not user:
            await message.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return

        if user[12]:  # is_frozen
            db.unfreeze_user(user_id)
            await message.answer(f"‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —Ä–∞–∑–º–æ—Ä–æ–∂–µ–Ω")

            try:
                await bot.send_message(user_id, "üî• –í–∞—à –±–∞–ª–∞–Ω—Å –±—ã–ª —Ä–∞–∑–º–æ—Ä–æ–∂–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º")
            except Exception:
                pass
        else:
            await message.answer("‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –±—ã–ª –∑–∞–º–æ—Ä–æ–∂–µ–Ω")

    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")

    await state.clear()

# –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
@dp.callback_query(lambda c: c.data == "admin_block_user")
async def admin_block_user_callback(callback: types.CallbackQuery, state: FSMContext):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    text = "üö´ <b>–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</b>\n\n–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
    await callback.message.edit_text(text, parse_mode="HTML")
    await state.set_state(AdminStates.waiting_block_user_id)

@dp.message(AdminStates.waiting_block_user_id)
async def process_block_user_id(message: types.Message, state: FSMContext):
    try:
        user_id = int(message.text)
        user = db.get_user(user_id)
        if not user:
            await message.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return

        await state.update_data(block_user_id=user_id)
        await message.answer(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user[2]}\nüìù –í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:")
        await state.set_state(AdminStates.waiting_block_reason)

    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")

@dp.message(AdminStates.waiting_block_reason)
async def process_block_reason(message: types.Message, state: FSMContext):
    data = await state.get_data()
    user_id = data.get('block_user_id')
    reason = message.text

    db.block_user(user_id, reason)

    await message.answer(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}")

    try:
        await bot.send_message(
            user_id,
            f"üö´ –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º\nüìù –ü—Ä–∏—á–∏–Ω–∞: {reason}\n\n–î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
        )
    except Exception:
        pass

    await state.clear()

# –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
@dp.callback_query(lambda c: c.data == "admin_unblock_user")
async def admin_unblock_user_callback(callback: types.CallbackQuery, state: FSMContext):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    text = "‚úÖ <b>–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</b>\n\n–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
    await callback.message.edit_text(text, parse_mode="HTML")
    await state.set_state(AdminStates.waiting_block_user_id)

@dp.message(AdminStates.waiting_block_user_id)
async def process_unblock_user_id(message: types.Message, state: FSMContext):
    try:
        user_id = int(message.text)
        user = db.get_user(user_id)
        if not user:
            await message.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return

        if user[11]:  # is_blocked
            db.unblock_user(user_id)
            await message.answer(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω")

            try:
                await bot.send_message(user_id, "‚úÖ –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –±—ã–ª —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º")
            except Exception:
                pass
        else:
            await message.answer("‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω")

    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")

    await state.clear()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞—è–≤–æ–∫
@dp.callback_query(lambda c: c.data.startswith("approve_withdrawal_"))
async def approve_withdrawal_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    withdrawal_id = int(callback.data.replace("approve_withdrawal_", ""))
    withdrawal = db.get_withdrawal_by_id(withdrawal_id)

    if withdrawal:
        db.update_withdrawal_status(withdrawal_id, "approved")

        try:
            await bot.send_message(
                withdrawal[1],
                f"‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ {withdrawal[2]}‚ÇΩ –æ–¥–æ–±—Ä–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –°—Ä–µ–¥—Å—Ç–≤–∞ –±—É–¥—É—Ç –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."
            )
        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {e}")

    await callback.answer("‚úÖ –í—ã–≤–æ–¥ –æ–¥–æ–±—Ä–µ–Ω", show_alert=True)
    await callback.message.edit_text("‚úÖ –í—ã–≤–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ–¥–æ–±—Ä–µ–Ω", reply_markup=get_back_to_admin_keyboard())

@dp.callback_query(lambda c: c.data.startswith("reject_withdrawal_"))
async def reject_withdrawal_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    withdrawal_id = int(callback.data.replace("reject_withdrawal_", ""))
    withdrawal = db.get_withdrawal_by_id(withdrawal_id)

    if withdrawal:
        db.update_balance(withdrawal[1], withdrawal[2])
        db.update_withdrawal_status(withdrawal_id, "rejected")

        try:
            await bot.send_message(
                withdrawal[1],
                f"‚ùå –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–≤–æ–¥ {withdrawal[2]}‚ÇΩ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –°—Ä–µ–¥—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å."
            )
        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {e}")

    await callback.answer("‚ùå –í—ã–≤–æ–¥ –æ—Ç–∫–ª–æ–Ω–µ–Ω", show_alert=True)
    await callback.message.edit_text("‚ùå –í—ã–≤–æ–¥ –æ—Ç–∫–ª–æ–Ω–µ–Ω", reply_markup=get_back_to_admin_keyboard())

@dp.callback_query(lambda c: c.data.startswith("approve_deposit_"))
async def approve_deposit_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    deposit_id = int(callback.data.replace("approve_deposit_", ""))
    deposit = db.get_deposit_by_id(deposit_id)

    if deposit:
        db.update_balance(deposit[1], deposit[2])
        db.update_deposit_status(deposit_id, "approved")
        db.add_operation(deposit[1], "deposit", deposit[2])

        try:
            await bot.send_message(
                deposit[1],
                f"‚úÖ –í–∞—à –±–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ {deposit[2]}‚ÇΩ. –ó–∞—è–≤–∫–∞ ‚Ññ{deposit_id} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."
            )
        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {e}")

    await callback.answer("‚úÖ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ", show_alert=True)
    await callback.message.edit_text("‚úÖ –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ", reply_markup=get_back_to_admin_keyboard())

@dp.callback_query(lambda c: c.data.startswith("reject_deposit_"))
async def reject_deposit_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    deposit_id = int(callback.data.replace("reject_deposit_", ""))
    deposit = db.get_deposit_by_id(deposit_id)

    if deposit:
        db.update_deposit_status(deposit_id, "rejected")

        try:
            await bot.send_message(
                deposit[1],
                f"‚ùå –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ ‚Ññ{deposit_id} –Ω–∞ —Å—É–º–º—É {deposit[2]}‚ÇΩ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –ï—Å–ª–∏ –≤—ã —É–∂–µ —Å–æ–≤–µ—Ä—à–∏–ª–∏ –æ–ø–ª–∞—Ç—É, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π."
            )
        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {e}")

    await callback.answer("‚ùå –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ", show_alert=True)
    await callback.message.edit_text("‚ùå –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ", reply_markup=get_back_to_admin_keyboard())

@dp.callback_query(lambda c: c.data.startswith("approve_support_"))
async def approve_support_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    request_id = int(callback.data.replace("approve_support_", ""))
    support_request = db.get_support_request_by_id(request_id)

    if support_request:
        db.update_support_request_status(request_id, "processed")

        try:
            await bot.send_message(
                support_request[1],
                f"‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É ‚Ññ{request_id} –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ!"
            )
        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {e}")

    await callback.answer("‚úÖ –ó–∞—è–≤–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞", show_alert=True)
    await callback.message.edit_text("‚úÖ –ó–∞—è–≤–∫–∞ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞", reply_markup=get_back_to_admin_keyboard())

@dp.callback_query(lambda c: c.data.startswith("reject_support_"))
async def reject_support_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    request_id = int(callback.data.replace("reject_support_", ""))
    support_request = db.get_support_request_by_id(request_id)

    if support_request:
        db.update_support_request_status(request_id, "rejected")

        try:
            await bot.send_message(
                support_request[1],
                f"‚ùå –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É ‚Ññ{request_id} –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ—Å—Ç–∞–ª—Å—è –∞–∫—Ç—É–∞–ª—å–Ω—ã–º, —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É."
            )
        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {e}")

    await callback.answer("‚ùå –ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞", show_alert=True)
    await callback.message.edit_text("‚ùå –ó–∞—è–≤–∫–∞ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞", reply_markup=get_back_to_admin_keyboard())

@dp.callback_query(lambda c: c.data.startswith("approve_reward_"))
async def approve_reward_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    request_id = int(callback.data.replace("approve_reward_", ""))
    reward_request = db.get_reward_request_by_id(request_id)

    if reward_request:
        db.update_balance(reward_request[1], reward_request[4])
        db.update_reward_request_status(request_id, "approved")
        db.add_operation(reward_request[1], "reward", reward_request[4])

        reward_names = {
            "post": "–ø–æ—Å—Ç –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö",
            "video": "–≤–∏–¥–µ–æ-–æ–±–∑–æ—Ä",
            "story": "—Å—Ç–æ—Ä–∏—Å",
            "review": "–æ—Ç–∑—ã–≤"
        }

        try:
            await bot.send_message(
                reward_request[1],
                f"‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –Ω–∞–≥—Ä–∞–¥—É –∑–∞ {reward_names.get(reward_request[2], reward_request[2])} –æ–¥–æ–±—Ä–µ–Ω–∞! –ù–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å –∑–∞—á–∏—Å–ª–µ–Ω–æ {reward_request[4]}‚ÇΩ."
            )
        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {e}")

    await callback.answer("‚úÖ –ù–∞–≥—Ä–∞–¥–∞ –≤—ã–ø–ª–∞—á–µ–Ω–∞", show_alert=True)
    await callback.message.edit_text("‚úÖ –ù–∞–≥—Ä–∞–¥–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–ª–∞—á–µ–Ω–∞", reply_markup=get_back_to_admin_keyboard())

@dp.callback_query(lambda c: c.data.startswith("reject_reward_"))
async def reject_reward_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    request_id = int(callback.data.replace("reject_reward_", ""))
    reward_request = db.get_reward_request_by_id(request_id)

    if reward_request:
        db.update_reward_request_status(request_id, "rejected")

        reward_names = {
            "post": "–ø–æ—Å—Ç –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö",
            "video": "–≤–∏–¥–µ–æ-–æ–±–∑–æ—Ä",
            "story": "—Å—Ç–æ—Ä–∏—Å",
            "review": "–æ—Ç–∑—ã–≤"
        }

        try:
            await bot.send_message(
                reward_request[1],
                f"‚ùå –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –Ω–∞–≥—Ä–∞–¥—É –∑–∞ {reward_names.get(reward_request[2], reward_request[2])} –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
            )
        except Exception as e:
            print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {e}")

    await callback.answer("‚ùå –ù–∞–≥—Ä–∞–¥–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞", show_alert=True)
    await callback.message.edit_text("‚ùå –ù–∞–≥—Ä–∞–¥–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞", reply_markup=get_back_to_admin_keyboard())

@dp.callback_query(lambda c: c.data == "admin_broadcast")
async def admin_broadcast_callback(callback: types.CallbackQuery, state: FSMContext):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    text = "üì¢ <b>–†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π</b>\n\n–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º:"
    await callback.message.edit_text(text, parse_mode="HTML")
    await state.set_state(AdminStates.waiting_broadcast)

@dp.message(AdminStates.waiting_broadcast)
async def process_broadcast(message: types.Message, state: FSMContext):
    users = db.get_all_users()
    success = 0
    failed = 0

    for user_id in users:
        try:
            await bot.send_message(user_id, message.text, parse_mode="HTML")
            success += 1
        except Exception:
            failed += 1
        await asyncio.sleep(0.1)

    await message.answer(f"‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞:\n–£—Å–ø–µ—à–Ω–æ: {success}\n–ù–µ —É–¥–∞–ª–æ—Å—å: {failed}")
    await state.clear()

@dp.callback_query(lambda c: c.data == "admin_deposit")
async def admin_deposit_callback(callback: types.CallbackQuery, state: FSMContext):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    text = "üí≥ <b>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</b>\n\n–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:"
    await callback.message.edit_text(text, parse_mode="HTML")
    await state.set_state(AdminStates.waiting_deposit_user_id)

@dp.message(AdminStates.waiting_deposit_user_id)
async def process_deposit_user_id(message: types.Message, state: FSMContext):
    try:
        user_id = int(message.text)
        user = db.get_user(user_id)
        if not user:
            await message.answer("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return

        await state.update_data(deposit_user_id=user_id)
        await message.answer(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user[2]}\nüíµ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:")
        await state.set_state(AdminStates.waiting_deposit_amount)

    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")

@dp.message(AdminStates.waiting_deposit_amount)
async def process_deposit_amount_admin(message: types.Message, state: FSMContext):
    try:
        amount = float(message.text)
        data = await state.get_data()
        user_id = data.get('deposit_user_id')

        db.update_balance(user_id, amount)
        db.add_operation(user_id, "admin_deposit", amount)

        await message.answer(f"‚úÖ –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ {amount}‚ÇΩ")

        try:
            await bot.send_message(user_id, f"‚úÖ –í–∞—à –±–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –Ω–∞ {amount}‚ÇΩ")
        except Exception:
            pass

        await state.clear()

    except ValueError:
        await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É")

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –±–æ—Ç–∞
@dp.callback_query(lambda c: c.data == "admin_management")
async def admin_management_callback(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    text = """
<b>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –±–æ—Ç–∞</b>

–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:

‚Ä¢ <b>–û—Å–Ω–æ–≤–Ω—ã–µ:</b> —Ç–æ–∫–µ–Ω –±–æ—Ç–∞, ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
‚Ä¢ <b>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ:</b> –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—É–º–º—ã, –ø—Ä–æ—Ü–µ–Ω—Ç—ã
‚Ä¢ <b>–ö–∞–Ω–∞–ª—ã:</b> –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
‚Ä¢ <b>–†–µ–∫–≤–∏–∑–∏—Ç—ã:</b> –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã
‚Ä¢ <b>–ù–∞–≥—Ä–∞–¥—ã:</b> –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è –∑–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    """

    await callback.message.edit_text(text, reply_markup=get_management_keyboard(), parse_mode="HTML")

# –û—Å–Ω–æ–≤–Ω—ã–µ callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
@dp.callback_query(lambda c: c.data == "back_to_main")
async def back_to_main(callback: types.CallbackQuery):
    user_id = callback.from_user.id
    if user_id in active_timers:
        active_timers[user_id] = False

    await callback.message.delete()
    welcome_text = f"""
<b>ü§ñ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {callback.from_user.first_name}!</b>

üíº <b>–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–º –¥–æ—Ö–æ–¥–æ–º.</b>

üìà <b>–ù–∞—á–Ω–∏—Ç–µ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ–ª—É—á–∞–π—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω—É—é –ø—Ä–∏–±—ã–ª—å!</b>

üëá <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é:</b>
    """
    await callback.message.answer(welcome_text, reply_markup=get_main_keyboard(), parse_mode="HTML")

@dp.callback_query(lambda c: c.data == "back_to_wallet")
async def back_to_wallet(callback: types.CallbackQuery):
    if not await check_user_access(callback):
        return
        
    user_id = callback.from_user.id
    user = db.get_user(user_id)

    balance = user[3] if user else 0.0
    ref_balance = user[4] if user else 0.0
    referrals_count = user[8] if user else 0

    text = f"""
<b>üÜî –í–∞—à ID:</b> {user_id}

üí∞ <b>–í–∞—à –±–∞–ª–∞–Ω—Å:</b> {balance:.2f}‚ÇΩ

üí≥ <b>–ü–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∏–π –±–∞–ª–∞–Ω—Å:</b> {ref_balance:.2f}‚ÇΩ
üë• <b>–ü–∞—Ä—Ç–Ω–µ—Ä–æ–≤:</b> {referrals_count} —á–µ–ª.
    """

    await callback.message.edit_text(text, reply_markup=get_wallet_keyboard(), parse_mode="HTML")

@dp.callback_query(lambda c: c.data == "back_to_settings")
async def back_to_settings(callback: types.CallbackQuery):
    if not await check_user_access(callback):
        return
        
    days_working = get_days_working()
    total_investors = db.get_active_investors_count()
    new_investors_24h = db.get_new_users_last_24h()
    online_now = db.get_online_users_count()

    text = f"""
<b>‚ñ™Ô∏è –í—ã –ø–æ–ø–∞–ª–∏ –≤ —Ä–∞–∑–¥–µ–ª –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞, –∑–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, –∞ —Ç–∞–∫–∂–µ —É–∑–Ω–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.</b>

üåê <b>–î–Ω–µ–π —Ä–∞–±–æ—Ç–∞–µ–º:</b> {days_working}
‚ñ™Ô∏è <b>–í—Å–µ–≥–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤:</b> {total_investors}
‚ñ™Ô∏è <b>–ù–æ–≤—ã—Ö –∑–∞ 24 —á–∞—Å–∞:</b> {new_investors_24h}
‚ñ™Ô∏è <b>–û–Ω–ª–∞–π–Ω:</b> {online_now}
    """

    await callback.message.edit_text(text, reply_markup=get_settings_keyboard(), parse_mode="HTML")

@dp.callback_query(lambda c: c.data == "admin_panel")
async def admin_panel_back(callback: types.CallbackQuery):
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("‚ùå –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω", show_alert=True)
        return

    text = "<b>üë®‚Äçüíº –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    await callback.message.edit_text(text, reply_markup=get_admin_keyboard(), parse_mode="HTML")

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    logging.basicConfig(level=logging.INFO)
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())

